<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>DOSBox-WASM GitHub Runner</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  input { width: 70%; }
  button { margin-left: 8px; }
  #log { background: #222; color: #eee; padding: 10px; height: 150px; overflow-y: auto; white-space: pre-wrap; margin-top: 10px; }
  #dosContainer { border: 1px solid #888; margin-top: 10px; width: 640px; height: 400px; }
</style>
</head>
<body>

<h2>DOSBox-WASM GitHub Runner & Dialog Box</h2>
<input id="repoUrl" type="text" placeholder="https://github.com/user/repo" />
<button id="runBtn">Load & Run</button>

<div id="log">Ready.</div>
<div id="dosContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@dreamlayers/dosbox-wasm@0.10.0/dist/dosbox.js"></script>

<script>
  const logEl = document.getElementById('log');
  const dosContainer = document.getElementById('dosContainer');

  function log(...args) {
    logEl.textContent += '\n' + args.join(' ');
    logEl.scrollTop = logEl.scrollHeight;
  }

  function parseGithubUrl(url) {
    try {
      const u = new URL(url);
      const parts = u.pathname.split('/').filter(Boolean);
      if(parts.length < 2) return null;
      return { owner: parts[0], repo: parts[1] };
    } catch {
      return null;
    }
  }

  async function findFileRecursively(owner, repo, exts, path = '') {
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`);
    if(!res.ok) throw new Error(`Failed fetching contents at ${path}`);
    const files = await res.json();
    for(const file of files) {
      if(file.type === 'file' && exts.some(ext => file.name.toLowerCase().endsWith(ext))) {
        return file;
      } else if(file.type === 'dir') {
        const found = await findFileRecursively(owner, repo, exts, file.path);
        if(found) return found;
      }
    }
    return null;
  }

  async function runProjectFromRepo(repoUrl) {
    log('Parsing URL...');
    const parsed = parseGithubUrl(repoUrl);
    if(!parsed) {
      alert('Invalid GitHub repo URL');
      return;
    }
    log(`Owner: ${parsed.owner}, Repo: ${parsed.repo}`);

    let fileToRun = await findFileRecursively(parsed.owner, parsed.repo, ['.bat']);
    let type = 'bat';
    if(!fileToRun) {
      fileToRun = await findFileRecursively(parsed.owner, parsed.repo, ['.exe']);
      type = 'exe';
    }
    if(!fileToRun) {
      alert('No BAT or EXE file found in repo.');
      return;
    }
    log(`Found ${type.toUpperCase()} file: ${fileToRun.name}`);
    log('Downloading file...');

    const fileResp = await fetch(fileToRun.download_url);
    if(!fileResp.ok) {
      alert('Failed to download the file');
      return;
    }
    const data = await (type === 'bat' ? fileResp.text() : fileResp.arrayBuffer());

    const zip = new JSZip();
    zip.file(fileToRun.name, data);
    zip.file('autoexec.bat', `${fileToRun.name}\nexit\n`);
    const blob = await zip.generateAsync({type: 'blob'});

    log('Starting DOSBox-WASM emulator...');
    dosContainer.innerHTML = ''; // clear container

    try {
      const dosbox = await DosBox({
        id: 'dosContainer',
        onstatus: (status) => log('DOSBox status: ' + status),
        onerror: (err) => log('DOSBox error: ' + err)
      });

      await dosbox.mountZip('/dos', blob);
      await dosbox.run('C:\\dos\\autoexec.bat');
      log('DOSBox started!');
    } catch(e) {
      log('DOSBox failed to start: ' + e);
    }
  }

  document.getElementById('runBtn').addEventListener('click', () => {
    logEl.textContent = 'Starting...\n';
    runProjectFromRepo(document.getElementById('repoUrl').value.trim());
  });
</script>

</body>
</html>
