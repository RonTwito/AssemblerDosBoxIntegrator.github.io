<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Assembly GitHub Runner (BAT & EXE only)</title>
  <script src="https://js-dos.com/cdn/js-dos-api.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { width: 70%; }
    button { margin-left: 8px; }
    #log { background: #222; color: #eee; padding: 10px; height: 150px; overflow-y: auto; white-space: pre-wrap; margin-top: 10px; }
    #dosCanvas { border: 1px solid #888; margin-top: 10px; width: 640px; height: 400px; }
  </style>
</head>
<body>
  <h2>Assembly GitHub Runner (BAT & EXE only)</h2>
  <input id="repoUrl" type="text" placeholder="https://github.com/user/repo" />
  <button id="runBtn">Load & Run</button>

  <div id="log">Ready.</div>
  <canvas id="dosCanvas"></canvas>

<script>
  const logEl = document.getElementById('log');
  function log(...args) {
    logEl.textContent += '\n' + args.join(' ');
    logEl.scrollTop = logEl.scrollHeight;
  }

  // פשוט מפצלים URL כדי לקבל owner ו-repo
  function parseGithubUrl(url) {
    try {
      const u = new URL(url);
      const parts = u.pathname.split('/').filter(Boolean);
      if(parts.length < 2) return null;
      return { owner: parts[0], repo: parts[1] };
    } catch {
      return null;
    }
  }

  // מחפש קבצים עם סיומות bat או exe ברפוזיטורי (כולל בתיקיות)
  async function findFileRecursively(owner, repo, exts, path = '') {
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`);
    if(!res.ok) throw new Error(`Failed fetching contents at ${path}`);
    const files = await res.json();
    for(const file of files) {
      if(file.type === 'file' && exts.some(ext => file.name.toLowerCase().endsWith(ext))) {
        return file;
      } else if(file.type === 'dir') {
        const found = await findFileRecursively(owner, repo, exts, file.path);
        if(found) return found;
      }
    }
    return null;
  }

  async function runProjectFromRepo(repoUrl) {
    log('Parsing URL...');
    const parsed = parseGithubUrl(repoUrl);
    if(!parsed) {
      alert('Invalid GitHub repo URL');
      return;
    }

    log(`Owner: ${parsed.owner}, Repo: ${parsed.repo}`);

    // מחפש BAT קודם, אחר כך EXE
    let fileToRun = await findFileRecursively(parsed.owner, parsed.repo, ['.bat']);
    let type = 'bat';
    if(!fileToRun) {
      fileToRun = await findFileRecursively(parsed.owner, parsed.repo, ['.exe']);
      type = 'exe';
    }
    if(!fileToRun) {
      alert('No BAT or EXE file found in repo.');
      return;
    }

    log(`Found ${type.toUpperCase()} file: ${fileToRun.name}`);
    log('Downloading file...');

    const fileResp = await fetch(fileToRun.download_url);
    if(!fileResp.ok) {
      alert('Failed to download the file');
      return;
    }
    const data = await (type === 'bat' ? fileResp.text() : fileResp.arrayBuffer());

    log('Creating DOS zip...');
    const zip = new JSZip();
    if(type === 'bat') {
      zip.file(fileToRun.name, data);
      zip.file('autoexec.bat', `${fileToRun.name}\nexit\n`);
    } else {
      zip.file(fileToRun.name, data);
      zip.file('autoexec.bat', `${fileToRun.name}\nexit\n`);
    }

    const blob = await zip.generateAsync({type: 'blob'});

    log('Starting js-dos emulator...');
    const canvas = document.getElementById('dosCanvas');
    window.Dos(canvas, { url: URL.createObjectURL(blob), autostart: true })
      .then(() => log('js-dos started!'))
      .catch(err => log('js-dos error:', err));
  }

  document.getElementById('runBtn').addEventListener('click', () => {
    logEl.textContent = 'Starting...\n';
    const url = document.getElementById('repoUrl').value.trim();
    runProjectFromRepo(url);
  });
</script>
</body>
</html>
